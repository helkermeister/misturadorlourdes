import { useState } from "react";
import { Button } from "@/components/ui/button";
import jsPDF from "jspdf";
import autoTable from "jspdf-autotable";

export default function MisturadorLourdes() {
  const turmasPadrao = [
    "1º Ano A", "1º Ano B", "1º Ano C",
    "2º Ano A", "2º Ano B", "2º Ano C",
    "3º Ano A", "3º Ano B"
  ];

  const [turmas, setTurmas] = useState(
    turmasPadrao.map(nome => ({
      nome,
      alunos: "Aluno1\nAluno2\nAluno3"
    }))
  );

  const [tabela, setTabela] = useState(null);

  const gerarTabela = () => {
    const alunosPorTurma = turmas.map(t => t.alunos.split("\n").map(a => a.trim()).filter(a => a));
    const tabelaTemp = Array(turmas.length).fill(null).map(() => Array(turmas.length).fill(""));

    alunosPorTurma.forEach((alunos, idx) => {
      let pos = 0;
      alunos.forEach(aluno => {
        tabelaTemp[idx][pos % turmas.length] += aluno + "\n";
        pos++;
      });
    });

    setTabela(tabelaTemp);
  };

  const exportarPDF = () => {
    const doc = new jsPDF({ orientation: "landscape" });
    const head = ["Turmas", ...turmas.map(t => t.nome), "Total"];

    const body = tabela.map((linha, idx) => {
      const linhaTexto = [turmas[idx].nome];
      let total = 0;
      linha.forEach(celula => {
        const alunos = celula.trim().split("\n").filter(a => a);
        linhaTexto.push(alunos.join("\n"));
        total += alunos.length;
      });
      linhaTexto.push(total);
      return linhaTexto;
    });

    const totalColuna = ["Total"];
    for (let i = 0; i < turmas.length; i++) {
      let soma = 0;
      tabela.forEach(l => {
        soma += l[i].trim().split("\n").filter(a => a).length;
      });
      totalColuna.push(soma);
    }
    totalColuna.push(totalColuna.slice(1).reduce((a, b) => a + b, 0));

    autoTable(doc, {
      head: [head],
      body: [...body, totalColuna]
    });

    doc.save("misturador_lourdes.pdf");
  };

  return (
    <div className="p-4 space-y-4 max-w-5xl mx-auto">
      <h1 className="text-xl font-bold text-center">Misturador Lourdes</h1>

      {turmas.map((turma, idx) => (
        <div key={idx} className="space-y-1">
          <label className="font-semibold">{turma.nome}</label>
          <textarea
            className="w-full border p-2 rounded min-h-[80px]"
            value={turma.alunos}
            onChange={e => {
              const newTurmas = [...turmas];
              newTurmas[idx].alunos = e.target.value;
              setTurmas(newTurmas);
            }}
          />
        </div>
      ))}

      <Button onClick={gerarTabela}>Gerar Tabela</Button>

      {tabela && (
        <>
          <Button onClick={exportarPDF}>Exportar PDF</Button>
          <div className="overflow-auto border mt-4">
            <table className="min-w-full text-xs">
              <thead>
                <tr>
                  <th className="border p-1">Turmas</th>
                  {turmas.map((t, idx) => (
                    <th key={idx} className="border p-1">{t.nome}</th>
                  ))}
                  <th className="border p-1">Total</th>
                </tr>
              </thead>
              <tbody>
                {tabela.map((linha, idx) => {
                  const total = linha.reduce((acc, cel) => acc + cel.trim().split("\n").filter(a => a).length, 0);
                  return (
                    <tr key={idx}>
                      <td className="border p-1 font-bold">{turmas[idx].nome}</td>
                      {linha.map((cel, j) => (
                        <td key={j} className="border p-1 whitespace-pre-wrap">{cel.trim()}</td>
                      ))}
                      <td className="border p-1 text-center font-bold">{total}</td>
                    </tr>
                  );
                })}
                <tr>
                  <td className="border p-1 font-bold">Total</td>
                  {turmas.map((_, colIdx) => {
                    let soma = 0;
                    tabela.forEach(l => {
                      soma += l[colIdx].trim().split("\n").filter(a => a).length;
                    });
                    return <td key={colIdx} className="border p-1 text-center font-bold">{soma}</td>;
                  })}
                  <td className="border p-1 text-center font-bold">
                    {turmas.map((_, colIdx) =>
                      tabela.reduce((acc, l) => acc + l[colIdx].trim().split("\n").filter(a => a).length, 0)
                    ).reduce((a, b) => a + b, 0)}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </>
      )}
    </div>
  );
}

</body>
</html>
